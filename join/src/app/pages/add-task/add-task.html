<div class="add-task-page">
  <header class="page-header">
    <h1>Add Task</h1>
  </header>

  <form [formGroup]="taskForm" class="content">
    <div class="left">
      <label>Title<span>*</span></label>
      <input formControlName="title" placeholder="Enter a title" />

      <label>Description</label>
      <textarea formControlName="description"></textarea>

      <label>Due date<span>*</span></label>
      <input type="date" formControlName="dueDate" />
    </div>

    <div class="right">
      <label>Priority</label>
      <div class="priority">
        <button
          type="button"
          *ngFor="let p of priorities"
          [class.active]="taskForm.value.priority === p"
          [ngClass]="p"
          (click)="taskForm.patchValue({ priority: p })"
        >
          <span class="label">{{ p }}</span>

          <img class="prio-icon" [src]="priorityIcons[p]" alt="" />
        </button>
      </div>

      <label>Assigned to</label>
      <div class="assignee-field" (click)="toggleAssigneeDropdown(true)" tabindex="0">
        <span class="placeholder"> Select contacts to assign </span>
        <img
          class="dropdown-arrow"
          [src]="assigneeOpen ? 'img/icons/dropup.svg' : 'img/icons/dropdown.svg'"
          (click)="$event.stopPropagation(); toggleAssigneeDropdown(!assigneeOpen)"
        />
      </div>

      <div class="assignee-avatars" *ngIf="(taskForm.value.assignedTo || []).length">
        <span
          class="avatar"
          *ngFor="let uid of taskForm.value.assignedTo"
          [style.background]="getContactColor(uid)"
          [title]="getContactName(uid)"
        >
          {{ (getContactName(uid) || '?').slice(0, 1).toUpperCase() }}
        </span>
      </div>

      <div class="assigned-list dropdown" *ngIf="assigneeOpen">
        <label
          class="assigned-item"
          *ngFor="let person of contacts"
          [class.selected]="(taskForm.value.assignedTo || []).includes(person.id!)"
          (mousedown)="
            toggleAssignee(person.id!, !(taskForm.value.assignedTo || []).includes(person.id!))
          "
        >
          <span class="avatar" [style.background]="person.color || '#6c63ff'">
            {{ (person.name || '?').slice(0, 1).toUpperCase() }}
          </span>

          <span class="name">{{ person.name }}</span>

          <img
            class="checkbox-icon"
            [src]="
              (taskForm.value.assignedTo || []).includes(person.id!)
                ? 'img/icons/checkbox-done.svg'
                : 'img/icons/checkbox-todo.svg'
            "
            alt="checkbox"
          />
        </label>
      </div>

      <label>Category<span>*</span></label>
      <select formControlName="category">
        <option value="">Select task category</option>
        <option value="user-story">User story</option>
        <option value="technical-task">Technical task</option>
      </select>

      <label>Subtasks</label>

      <div class="subtask-input-wrapper">
        <input
          [(ngModel)]="newSubtaskTitle"
          [ngModelOptions]="{ standalone: true }"
          placeholder="Add new subtask"
          (focus)="subtaskFocus = true"
          (blur)="!newSubtaskTitle && (subtaskFocus = false)"
          (keydown.enter)="$event.preventDefault(); addSubtask()"
        />

        <span class="subtask-icons" *ngIf="subtaskFocus">
          <button
            type="button"
            class="icon-btn"
            (click)="clearSubtaskInput(); subtaskFocus = false"
          >
            <img src="img/icons/close_black.svg" alt="Clear" />
          </button>

          <span class="divider"></span>

          <button type="button" class="icon-btn" (click)="addSubtask()">
            <img src="img/icons/check-hover.svg" alt="Add" />
          </button>
        </span>
      </div>

      <ul class="subtask-list">
        <li *ngFor="let s of subtasks">
          <span class="subtask-title">{{ s.title }}</span>

          <div class="item-actions">
            <button type="button" class="icon-btn" (click)="startEditSubtask(s.id, s.title)">
              <img src="img/icons/edit.svg" alt="Edit" />
            </button>

            <span class="divider-small"></span>

            <button type="button" class="icon-btn" (click)="removeSubtask(s.id)">
              <img src="img/icons/delete.svg" alt="Delete" />
            </button>
          </div>
        </li>
      </ul>
    </div>
  </form>

  <footer class="actions">
    <span class="required-hint"> <span class="asterisk">*</span>This field is required </span>

    <div class="action-buttons">
      <button class="clear" type="button" (click)="clearForm()">
        Clear
        <img class="btn-icon" src="img/icons/close_black.svg" alt="clear icon" />
      </button>

      <button class="submit" [disabled]="taskForm.invalid" (click)="createTask()">
        Create Task
        <img class="btn-icon" src="img/icons/check.svg" alt="check icon" />
      </button>
    </div>
  </footer>
</div>
