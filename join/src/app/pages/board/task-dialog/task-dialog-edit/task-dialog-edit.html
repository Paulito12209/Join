<div class="edit" (click)="assigneeOpen = false">
  <form [formGroup]="editForm" class="edit-form">
    <div class="label-input-wrapper">
      <label>Title</label>
      <input formControlName="title" placeholder="Enter a title" />
    </div>

    <div class="label-input-wrapper">
      <label>Description</label>
      <div class="textarea-wrapper">
        <textarea formControlName="description" placeholder="Enter a Description"></textarea>
      </div>
    </div>

    <div class="label-input-wrapper">
      <label>Due date</label>

      <input
        #dateInput
        type="date"
        formControlName="dueDate"
        required
        (click)="dateInput.showPicker()"
      />
    </div>

    <!-- PRIORITY -->
    <div class="priority-wrapper">
      <label>Priority</label>

      <div class="priority">
        <button
          type="button"
          class="prio-urgent"
          [class.active]="(editForm.value.priority || '').toLowerCase() === 'urgent'"
          (click)="editForm.patchValue({ priority: 'urgent' })"
        >
          Urgent
          <img src="img/icons/prio-urgent.svg" alt="Urgent" />
        </button>

        <button
          type="button"
          class="prio-medium"
          [class.active]="(editForm.value.priority || '').toLowerCase() === 'medium'"
          (click)="editForm.patchValue({ priority: 'medium' })"
        >
          Medium
          <img src="img/icons/prio-medium.svg" alt="Medium" />
        </button>

        <button
          type="button"
          class="prio-low"
          [class.active]="(editForm.value.priority || '').toLowerCase() === 'low'"
          (click)="editForm.patchValue({ priority: 'low' })"
        >
          Low
          <img src="img/icons/prio-low.svg" alt="Low" />
        </button>
      </div>
    </div>

    <!-- ASSIGNED TO -->
    <div class="assigned-wrapper">
      <label>Assigned to</label>

      <div class="assigned-dropdown" (click)="$event.stopPropagation()">
        <div class="assigned-input" (click)="assigneeOpen = !assigneeOpen">
          <input type="text" placeholder="Select contacts to assign" readonly />
          <span class="dropdown-arrow" [class.dropdown-arrow--open]="assigneeOpen"></span>
        </div>

        @if (assigneeOpen) {
        <div class="dropdown-list">
          @for (contact of (contacts ?? []); track contact.id) { @if (contact.id) {
          <div
            class="dropdown-item"
            [class.selected]="isAssigned(contact.id)"
            (click)="toggleAssignee(contact.id, !isAssigned(contact.id)); $event.stopPropagation()"
          >
            <span class="avatar" [ngStyle]="{ background: contact.color }">
              {{ getInitials(contact.name) }}
            </span>

            <span class="name">{{ contact.name }}</span>

            <input
              type="checkbox"
              [checked]="isAssigned(contact.id)"
              (click)="$event.stopPropagation(); toggleAssignee(contact.id, $event.target.checked)"
            />
          </div>
          } }
        </div>
        }
      </div>

      <div class="assigned-badges">
        @for (uid of selectedAssigneeIds; track uid) {
        <span class="badge-avatar" [ngStyle]="{ background: getContactColor(uid) }">
          {{ getContactInitials(uid) }}
        </span>
        }
      </div>
    </div>

    <!-- SUBTASKS -->
    <div class="subtasks-row">
      <label>Subtasks</label>

      <div class="subtask-input-wrapper" [class.focused]="subtaskFocus">
        <input
          [(ngModel)]="newSubtaskTitle"
          [ngModelOptions]="{ standalone: true }"
          (focus)="subtaskFocus = true"
          (keydown.enter)="$event.preventDefault(); addSubtask()"
          placeholder="Add new subtask"
          name="subtaskInput"
        />

        <span class="subtask-icons">
          @if (!subtaskFocus && !newSubtaskTitle) {
          <button type="button" class="icon-btn" (click)="subtaskFocus = true">
            <img src="img/icons/add.svg" alt="Add" />
          </button>
          } @else {
          <button
            type="button"
            class="icon-btn"
            (click)="clearSubtaskInput(); subtaskFocus = false"
          >
            <img src="img/icons/close-small-dark.svg" alt="Clear" />
          </button>

          <span class="divider"></span>

          <button type="button" class="icon-btn" (click)="addSubtask()">
            <img src="img/icons/check-small-dark.svg" alt="Add" />
          </button>
          }
        </span>
      </div>

      <ul class="subtask-list">
        @for (subtask of subtasks; track subtask.id) {
        <li>
          @if (editSubtaskId !== subtask.id) {
          <span class="subtask-bullet">â€¢</span>
          <span class="subtask-title">{{ subtask.title }}</span>

          <div class="item-actions">
            <button
              type="button"
              class="icon-btn"
              (click)="startEditSubtask(subtask.id, subtask.title)"
            >
              <img src="img/icons/edit-hover.svg" alt="Edit" />
            </button>

            <span class="divider-small"></span>

            <button type="button" class="icon-btn" (click)="removeSubtask(subtask.id)">
              <img src="img/icons/delete.svg" alt="Delete" />
            </button>
          </div>
          } @else {
          <div class="edit-wrapper">
            <input
              [(ngModel)]="editSubtaskTitle"
              [ngModelOptions]="{ standalone: true }"
              class="edit-input"
            />

            <div class="edit-actions">
              <button type="button" class="icon-btn" (click)="removeSubtask(subtask.id)">
                <img src="img/icons/delete.svg" alt="Delete" />
              </button>

              <span class="divider-small"></span>

              <button type="button" class="icon-btn" (click)="saveEditSubtask(subtask.id)">
                <img src="img/icons/check-small-dark.svg" alt="Save" />
              </button>
            </div>
          </div>
          }
        </li>
        }
      </ul>
    </div>
  </form>
</div>
